# Модальное окно выбора плеера

## Описание функционала

Реализована система модального окна для выбора плеера при нажатии на карточку фильма.

## Как работает

### 1. При нажатии на карточку фильма:

- Открывается модальное окно с выбором плеера
- Автоматически делается запрос к API для получения `kp_id` фильма
- Пользователю предлагается выбор из двух плееров

### 2. API запросы:

- **Получение kp_id**: `https://api.vokino.tv/v2/timeline/watch?ident=${movie.ident}&current=99&time=0&token=${token}`
- **Token**: `windows_93e27bdd4ca8bfd43c106e8d96f09502_1164344`

### 3. Плееры:

#### Renewall плеер

- При нажатии делается запрос: `https://api.bhcesh.me/franchise/details?token=eedefb541aeba871dcfc756e6b31c02e&kinopoisk_id=${kp_id}`
- Получается `iframe_url` из ответа
- Загружается прямо в модалке как встроенный iframe

#### Turbo плеер

- При нажатии загружается iframe прямо в модалке
- URL плеера: `https://92d73433.obrut.show/embed/MjM/kinopoisk/${kp_id}`
- Встроенный плеер с возможностью закрытия

## Исправленные проблемы

### Проблема с закрытием модалки

- **Проблема**: После закрытия плеера крестик модалки не работал
- **Решение**: Разделены функции `handleClosePlayer()` и `handleClose()`
- **Результат**: Закрытие плеера не закрывает модалку

### Renewall плеер API

- **Проблема**: Открывался в новой вкладке вместо использования iframe_url
- **Решение**: Добавлен запрос к API и получение `iframe_url`
- **Результат**: Renewall плеер теперь работает как встроенный iframe

## Файлы которые были изменены:

### 1. `/src/components/PlayerModal.jsx` (новый файл)

- Компонент модального окна с выбором плеера
- Обработка API запросов для получения kp_id
- Интеграция с плеерами Renewall и Turbo
- Обработка ошибок и состояний загрузки

### 2. `/src/components/MovieCard.jsx`

- Добавлен импорт PlayerModal
- Добавлено состояние `isPlayerModalOpen`
- Обновлен `handleCardClick` для открытия модалки
- Добавлен рендер компонента PlayerModal

### 3. `/src/services/api.js`

- Добавлена функция `getMovieKpId()` для получения kp_id
- Добавлена функция `getRenewall()` для работы с Renewall API
- Добавлена функция `getTurboPlayerUrl()` для генерации URL Turbo плеера

### 4. `/src/utils/dataTransformers.js`

- Добавлено сохранение `ident: apiMovie.ident` в трансформации данных

### 5. `/src/pages/MoviesPage.jsx` и `/src/pages/SeriesPage.jsx`

- Обновлены локальные функции трансформации для сохранения `ident`

### 6. `/src/index.css`

- Добавлены стили для плеера
- Улучшенные стили для кнопок плеера с анимациями

## Использование

1. Пользователь нажимает на карточку фильма
2. Открывается модальное окно с информацией о фильме
3. Пользователь выбирает один из плееров:
   - **Renewall** - загрузится прямо в модалке
   - **Turbo** - загрузится прямо в модалке
4. Плеер открывается в том же модальном окне **без кнопки закрытия**
5. Для закрытия нужно нажать **крестик в заголовке модального окна** - это закроет все модальное окно полностью

## Обработка ошибок

- Если отсутствует `ident` или `id` фильма - показывается ошибка
- Если API недоступно - показывается сообщение об ошибке
- Если `kp_id` не найден - показывается соответствующее сообщение
- Индикатор загрузки во время выполнения запросов
- Отладочная информация о доступных идентификаторах

## Особенности

- Автоматическое определение идентификатора (`ident` или `id`)
- Отладочная информация о доступных идентификаторах
- Адаптивный дизайн для мобильных устройств
- Поддержка родительского контроля (18+ контент)
- Красивые анимации и переходы
- Автоматическое закрытие модалки при выборе внешнего плеера
- Сохранение состояния kp_id для повторного использования
